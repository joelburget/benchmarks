{% extends "base.html" %}
{% load gravatar %}
{% load comments %}

{% block title %}{{ object.title }}{% endblock %}

{% block jsheadblock %}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}jqueryFileTree/jqueryFileTree.js" />

<script type="text/javascript">
$(document).ready( function() {
  $('#files').fileTree(
    {
      root: '{{ object.pk }}/',
      script: '/dirlist'
    },
    function(file) {
      window.location.href = ('{{ MEDIA_URL }}' + file.replace('{{ SITE_ROOT }}/assets/', ''));
    });
});
</script>
{% endblock %}

{% block cssblock %}
<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}jqueryFileTree/jqueryFileTree.css" />
{% endblock %}

{% block content %}
<!-- Title -->
<h2>{{ object.title }}</span></h2>
{% if object.parent %}
<h4>In response to <a href="{{ object.parent.get_absolute_url }}">{{ object.parent.title }}</a></h4>
{% endif %}

<!-- Body -->
<div id="post-content">{{ object.body|safe }}</div>

<!-- Files -->
{% if object.postfile_set.all %}
<div id="files">
<h3>Files:</h3>
<ul>
{% for f in object.postfile_set.all %}
  <li><a href="{{ MEDIA_URL }}{{ f.file }}">{{ f }}</a></li>
{% endfor %}
</ul>
</div>
{% endif %}

<!-- Poster info -->
<p class="postInfo"><span class="postType"><a href="">{{ object.get_category_display }}</a></span> Posted by: <a href="{{ object.author.get_absolute_url }}">{{ object.author.first_name }} {{ object.author.last_name }}</a>, on {{ object.published }}</p> 

{% if object.post_set.all %}
  <h4>Responses:</h4>
  {% for response in object.post_set.all %}
    <a href="{{ response.get_absolute_url }}">{{ response.title }}</a>
    <br />
  {% endfor %}
{% endif %}

<!-- Comments -->
<div id="comments">
{% get_comment_count for object as comment_count %}
<h2>Discussion &mdash; {{ comment_count }} comment{{ comment_count|pluralize }}</h2>

{% get_comment_list for object as comment_list %}
{% for comment in comment_list %}
  <div id="c{{ comment.id }}">
    <p class="commentBox">{{ comment.submit_date|date:"F j, Y" }} at {{ comment.submit_date|date:"P" }} - <a href="{{ comment.user.get_absolute_url }}">{{ comment.name|escape }}</a></p> 
    <div class="gravatar"><a href="{{ comment.user.get_absolute_url }}">{% gravatar comment.user.email 48 %}</a></div>
    <div class="comment">{{ comment.comment|safe|linebreaks }}</div>
  </div>
{% endfor %}

<!-- Comment form -->
{% if user.is_authenticated %}
  <h3 style="clear:both;">Leave a comment</h3>
  {% get_comment_form for object as form %}
  <form action="{% comment_form_target %}" method="post" enctype="multipart/form-data"> 
    {% csrf_token %}
    {{ form.comment }} 
    {{ form.content_type }} 
    {{ form.object_pk }} 
    {{ form.timestamp }} 
    {{ form.security_hash }} 
    <br />
    {{ form.file }}
    <p style="display:none;"> {{ form.honeypot }}</p>
    <input type="submit" name="preview" class="submit-preview" value="Preview" />
    <input type="submit" value="Add comment" class="submit-post" id="id_submit" />
  </form> 
{% endif %}
</div>
{% endblock %}
